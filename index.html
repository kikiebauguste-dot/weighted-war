<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weighted War</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#ef4444; --warn:#f59e0b;
    }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; background:#0b1220; border-bottom:1px solid #1f2937; }
    header h1 { margin:0; font-size:20px; }
    main { max-width:900px; margin:24px auto; padding:0 16px; }
    .card { background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow { flex:1; }
    input[type=text] { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--text); }
    button { background:#1f2937; color:var(--text); border:1px solid #374151; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.primary { background:var(--accent); border-color:#16a34a; color:#04210f; font-weight:600; }
    button.secondary { background:var(--accent2); border-color:#3b82f6; color:#041421; font-weight:600; }
    button.warn { background:var(--warn); border-color:#d97706; color:#1f1202; font-weight:600; }
    button.danger { background:var(--danger); border-color:#b91c1c; color:#160404; font-weight:600; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #374151; background:#0b1220; color:var(--muted); }
    .muted { color:var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(44px, 1fr)); gap:8px; }
    .bid { background:#0b1220; border:1px solid #374151; border-radius:8px; padding:10px; text-align:center; cursor:pointer; }
    .bid.selected { outline:2px solid var(--accent2); border-color:#3b82f6; }
    .section-title { font-weight:700; margin-bottom:8px; }
    .bignum { font-size:54px; font-weight:800; line-height:1; }
    .stack { display:flex; gap:8px; flex-wrap:wrap; }
    .cardface { padding:10px 14px; border-radius:8px; background:#0b1220; border:1px solid #374151; min-width:52px; text-align:center; }
    .footnote { font-size:12px; color:#94a3b8; margin-top:6px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Weighted War</h1>
  </header>
  <main>
    <div class="card" id="connectCard">
      <div class="section-title">Game setup</div>
      <div class="row">
        <div class="grow">
          <label class="muted">Game ID</label>
          <input type="text" id="gameIdInput" placeholder="e.g., bothell-123" />
        </div>
        <div>
          <button class="primary" id="createBtn">Create game</button>
        </div>
        <div>
          <button class="secondary" id="joinBtn">Join game</button>
        </div>
      </div>
      <div class="footnote">Share the URL containing ?game=YOUR_ID with your friend after creating the game.</div>
    </div>

    <div class="card hidden" id="linkCard">
      <div class="section-title">Share link</div>
      <div class="row">
        <div class="grow">
          <input type="text" id="shareLink" readonly />
        </div>
        <div>
          <button id="copyLink">Copy</button>
        </div>
      </div>
    </div>

    <div class="card hidden" id="statusCard">
      <div class="row">
        <div class="grow">
          <div class="section-title">Status</div>
          <div id="statusText" class="muted">Waiting…</div>
        </div>
        <div><span class="pill" id="youPill">You: —</span></div>
        <div><span class="pill" id="oppPill">Opponent: —</span></div>
      </div>
    </div>

    <div class="card hidden" id="gameCard">
      <div class="row">
        <div class="grow">
          <div class="section-title">Table card</div>
          <div id="tableCard" class="bignum">—</div>
          <div class="footnote" id="warNote">No war in progress.</div>
        </div>
        <div>
          <div class="section-title">Your score</div>
          <div id="yourScore" class="bignum">0</div>
          <div class="section-title" style="margin-top:12px;">Opponent score</div>
          <div id="oppScore" class="bignum">0</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:12px;">Your hand</div>
      <div class="grid" id="handGrid"></div>

      <div class="row" style="margin-top:12px;">
        <button id="commitBidBtn" class="primary">Commit bid</button>
        <button id="revealBtn" class="secondary">Reveal bids</button>
        <button id="nextTurnBtn" class="warn">Next turn</button>
        <button id="resetBtn" class="danger">Reset game</button>
      </div>

      <div class="section-title" style="margin-top:16px;">War pile</div>
      <div class="stack" id="warStack"></div>

      <div class="section-title" style="margin-top:16px;">Log</div>
      <div id="log" class="footnote"></div>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, child, get, set, update, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    // 1) Paste your Firebase config here
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyC8yo4XBJCJ_1FaEVzPKOMlN_Kue0Ff5yQ",
      authDomain: "weighted-wars.firebaseapp.com",
      databaseURL: "https://weighted-wars-default-rtdb.firebaseio.com",
      projectId: "weighted-wars",
      storageBucket: "weighted-wars.firebasestorage.app",
      messagingSenderId: "575150999392",
      appId: "1:575150999392:web:6cdea188b68fbec7d10005",
      measurementId: "G-RGTQRM0ND3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

  // --- Globals ---
  let gameId = null;
  let youId = null;
  let role = null;
  let youName = null;
  let state = null;
  let selectedBid = null;

  // --- Helpers ---
  const gameRef = () => ref(db, 'weighted-war/' + gameId);
  const stateRef = () => child(gameRef(), 'state');
  const range11 = () => Array.from({length: 11}, (_, i) => i+1);
  const log = (msg) => { const el = document.getElementById('log'); el.textContent += msg + "\\n"; };

  // --- Initial state ---
  function initialState() {
    const removed = Math.floor(Math.random() * 11) + 1;
    const tableDeck = range11().filter(v => v !== removed).sort(() => Math.random() - 0.5);
    return {
      createdAt: Date.now(),
      removedCard: removed,
      tableDeck,
      tableIndex: 0,
      currentTableCard: null,
      warPile: [],
      p1: { hand: range11(), bid: null, scoreCards: [], name: '' },
      p2: { hand: range11(), bid: null, scoreCards: [], name: '' },
      phase: 'await-flip',
      winner: null
    };
  }

  // --- Create game ---
  async function createGame(id, yourNameInput) {
    gameId = id;
    youId = 'u_' + Math.random().toString(36).slice(2);
    role = 'p1';
    youName = yourNameInput || 'Player 1';

    const refObj = gameRef();
    const exists = (await get(refObj)).val();
    if (exists) { alert('Game ID already exists.'); return; }

    const init = initialState();
    init.p1.name = youName;
    await set(refObj, { state: init, players: { p1: youId } });

    // Flip first card immediately
    if (init.tableDeck.length > 0) {
      const firstCard = init.tableDeck[0];
      await update(stateRef(), {
        currentTableCard: firstCard,
        tableIndex: 1,
        phase: 'await-bids'
      });
      log(`Game created. First table card is ${firstCard}. Place your bid!`);
    }

    render();
  }

  // --- Join game ---
  async function joinGame(id, yourNameInput) {
    gameId = id;
    youId = 'u_' + Math.random().toString(36).slice(2);
    role = 'p2';
    youName = yourNameInput || 'Player 2';

    const refObj = gameRef();
    const current = (await get(refObj)).val();
    if (!current) { alert('Game not found.'); return; }

    await runTransaction(child(refObj, 'players/p2'), val => val || youId);

    const p2Update = {
      name: youName,
      hand: current.state?.p2?.hand || range11(),
      bid: null,
      scoreCards: current.state?.p2?.scoreCards || []
    };
    await set(child(stateRef(), 'p2'), p2Update);

    render();
  }

  // --- Flip table card ---
  async function flipTableCard() {
    if (!state) return;
    if (state.phase !== 'await-flip') return;

    if (state.tableIndex >= state.tableDeck.length) {
      log("Game finished.");
      return;
    }

    const next = state.tableDeck[state.tableIndex];
    await update(stateRef(), {
      currentTableCard: next,
      tableIndex: state.tableIndex + 1,
      phase: 'await-bids'
    });
    log(`Table shows ${next}. Place your bid.`);
  }

  // --- Commit bid ---
  async function commitBid() {
    if (!state) { alert("Game state not loaded yet."); return; }
    if (state.phase !== 'await-bids') return;
    if (selectedBid === null) return;

    const hand = state[role].hand.slice();
    const idx = hand.indexOf(selectedBid);
    if (idx === -1) { alert('That card is no longer in your hand.'); return; }

    const updates = {};
    updates[role + '/bid'] = selectedBid;
    hand.splice(idx, 1);
    updates[role + '/hand'] = hand;
    await update(stateRef(), updates);

    const fresh = (await get(stateRef())).val();
    if (fresh && fresh.p1.bid !== null && fresh.p2.bid !== null && fresh.phase === 'await-bids') {
      await update(stateRef(), { phase: 'await-reveal' });
    }

    render();
  }

  // --- Reveal bids ---
  async function revealBidsAndResolve() {
    if (!state) { alert("Game state not loaded yet."); return; }
    if (state.phase !== 'await-reveal') return;

    const p1b = state.p1.bid, p2b = state.p2.bid;
    const tableCard = state.currentTableCard;
    log(`Reveal: P1 bid ${p1b}, P2 bid ${p2b}, table ${tableCard}`);

    if (p1b === p2b) {
      const newWar = state.warPile.slice();
      newWar.push(tableCard);
      await update(stateRef(), {
        warPile: newWar,
        currentTableCard: null,
        p1: { ...state.p1, bid: null },
        p2: { ...state.p2, bid: null },
        phase: 'await-flip'
      });
      log(`War continues. Pile size: ${newWar.length}`);
      return;
    }

    const winner = (p1b > p2b) ? 'p1' : 'p2';
    const wonCards = [tableCard, ...state.warPile];
    const winnerCards = state[winner].scoreCards.slice();
    wonCards.forEach(c => winnerCards.push(c));

    await update(stateRef(), {
      [winner]: { ...state[winner], scoreCards: winnerCards },
      warPile: [],
      phase: 'resolution'
    });
    log(`${winner.toUpperCase()} wins ${wonCards.join(', ')}.`);
  }

  // --- Next turn ---
  async function nextTurn() {
    if (!state) { alert("Game state not loaded yet."); return; }
    if (!state.phase) { alert("Game phase not set yet."); return; }
    if (state.phase !== 'resolution') {
      log("Next turn not available. Current phase: " + state.phase);
      return;
    }

    const updates = {
      currentTableCard: null,
      p1: { ...state.p1, bid: null },
      p2: { ...state.p2, bid: null },
      phase: 'await-flip'
    };
    await update(stateRef(), updates);

    await flipTableCard();
    selectedBid = null;
    render();
  }

  // --- Listener ---
  onValue(stateRef(), (snap) => {
    state = snap.val();
    render();
  });

  // --- Render ---
  function render() {
    if (!state) return;
    document.getElementById('youPill').textContent = `You: ${state[role].name || '—'}`;
    document.getElementById('oppPill').textContent = `Opponent: ${state[role==='p1'?'p2':'p1'].name || '—'}`;
    document.getElementById('tableCard').textContent = `Table card ${state.currentTableCard || '—'}`;
    document.getElementById('commitBidBtn').disabled = !state || state.phase !== 'await-bids' || selectedBid === null;
    document.getElementById('revealBtn').disabled = !state || state.phase !== 'await-reveal';
    document.getElementById('nextTurnBtn').disabled = !state || state.phase !== 'resolution';
  }

  // --- Button bindings ---
  document.getElementById('commitBidBtn').onclick = commitBid;
  document.getElementById('revealBtn').onclick = revealBidsAndResolve;
  document.getElementById('nextTurnBtn').onclick = nextTurn;
</script>
</body>
</html>