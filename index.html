<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weighted War</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#ef4444; --warn:#f59e0b;
    }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; background:#0b1220; border-bottom:1px solid #1f2937; }
    header h1 { margin:0; font-size:20px; }
    main { max-width:900px; margin:24px auto; padding:0 16px; }
    .card { background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow { flex:1; }
    input[type=text] { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--text); }
    button { background:#1f2937; color:var(--text); border:1px solid #374151; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.primary { background:var(--accent); border-color:#16a34a; color:#04210f; font-weight:600; }
    button.secondary { background:var(--accent2); border-color:#3b82f6; color:#041421; font-weight:600; }
    button.warn { background:var(--warn); border-color:#d97706; color:#1f1202; font-weight:600; }
    button.danger { background:var(--danger); border-color:#b91c1c; color:#160404; font-weight:600; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #374151; background:#0b1220; color:var(--muted); }
    .muted { color:var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(44px, 1fr)); gap:8px; }
    .bid { background:#0b1220; border:1px solid #374151; border-radius:8px; padding:10px; text-align:center; cursor:pointer; }
    .bid.selected { outline:2px solid var(--accent2); border-color:#3b82f6; }
    .section-title { font-weight:700; margin-bottom:8px; }
    .bignum { font-size:54px; font-weight:800; line-height:1; }
    .stack { display:flex; gap:8px; flex-wrap:wrap; }
    .cardface { padding:10px 14px; border-radius:8px; background:#0b1220; border:1px solid #374151; min-width:52px; text-align:center; }
    .footnote { font-size:12px; color:#94a3b8; margin-top:6px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Weighted War</h1>
  </header>
  <main>
    <div class="card" id="connectCard">
      <div class="section-title">Game setup</div>
      <div class="row">
        <div class="grow">
          <label class="muted">Game ID</label>
          <input type="text" id="gameIdInput" placeholder="e.g., bothell-123" />
        </div>
        <div>
          <button class="primary" id="createBtn">Create game</button>
        </div>
        <div>
          <button class="secondary" id="joinBtn">Join game</button>
        </div>
      </div>
      <div class="footnote">Share the URL containing ?game=YOUR_ID with your friend after creating the game.</div>
    </div>

    <div class="card hidden" id="linkCard">
      <div class="section-title">Share link</div>
      <div class="row">
        <div class="grow">
          <input type="text" id="shareLink" readonly />
        </div>
        <div>
          <button id="copyLink">Copy</button>
        </div>
      </div>
    </div>

    <div class="card hidden" id="statusCard">
      <div class="row">
        <div class="grow">
          <div class="section-title">Status</div>
          <div id="statusText" class="muted">Waiting…</div>
        </div>
        <div><span class="pill" id="youPill">You: —</span></div>
        <div><span class="pill" id="oppPill">Opponent: —</span></div>
      </div>
    </div>

    <div class="card hidden" id="gameCard">
      <div class="row">
        <div class="grow">
          <div class="section-title">Table card</div>
          <div id="tableCard" class="bignum">—</div>
          <div class="footnote" id="warNote">No war in progress.</div>
        </div>
        <div>
          <div class="section-title">Your score</div>
          <div id="yourScore" class="bignum">0</div>
          <div class="section-title" style="margin-top:12px;">Opponent score</div>
          <div id="oppScore" class="bignum">0</div>
        </div>
      </div>

      <div class="section-title" style="margin-top:12px;">Your hand</div>
      <div class="grid" id="handGrid"></div>

      <div class="row" style="margin-top:12px;">
        <button id="commitBidBtn" class="primary">Commit bid</button>
        <button id="revealBtn" class="secondary">Reveal bids</button>
        <button id="nextTurnBtn" class="warn">Next turn</button>
        <button id="resetBtn" class="danger">Reset game</button>
      </div>

      <div class="section-title" style="margin-top:16px;">War pile</div>
      <div class="stack" id="warStack"></div>

      <div class="section-title" style="margin-top:16px;">Log</div>
      <div id="log" class="footnote"></div>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script>
    // 1) Paste your Firebase config here
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyC8yo4XBJCJ_1FaEVzPKOMlN_Kue0Ff5yQ",
      authDomain: "weighted-wars.firebaseapp.com",
      databaseURL: "https://weighted-wars-default-rtdb.firebaseio.com",
      projectId: "weighted-wars",
      storageBucket: "weighted-wars.firebasestorage.app",
      messagingSenderId: "575150999392",
      appId: "1:575150999392:web:6cdea188b68fbec7d10005",
      measurementId: "G-RGTQRM0ND3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2) Utility helpers
    const $ = (id) => document.getElementById(id);
    const setHidden = (el, hidden) => el.classList.toggle('hidden', hidden);
    const log = (msg) => { const d = document.createElement('div'); d.textContent = msg; $('log').prepend(d); };

    // 3) Game state (client-side mirrors server)
    let gameId = '';
    let youId = '';
    let youName = '';
    let oppId = '';
    let role = ''; // 'p1' or 'p2'
    let state = null; // latest synced state
    let selectedBid = null;

    // 4) Derived paths
    const gameRef = () => db.ref('weighted-war/' + gameId);
    const stateRef = () => db.ref('weighted-war/' + gameId + '/state');

    // 5) Deck helpers for 1..11
    const range11 = () => Array.from({length:11}, (_,i)=>i+1);
    const shuffle = (arr) => {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    };

    // 6) Initial state generator
    function initialState() {
      const tableDeck = shuffle(range11());
      // remove one random card from table deck at start
      const removed = tableDeck.pop(); // since shuffled, popping is effectively random
      const p1Hand = range11();
      const p2Hand = range11();
      return {
        createdAt: Date.now(),
        removedCard: removed,
        tableDeck,
        tableIndex: 0,              // position for next flip
        currentTableCard: null,     // shown card this turn
        warPile: [],                // accumulated table cards during ties
        p1: {
          hand: p1Hand,
          bid: null,
          scoreCards: [],
          name: ''
        },
        p2: {
          hand: p2Hand,
          bid: null,
          scoreCards: [],
          name: ''
        },
        phase: 'await-flip',        // 'await-flip' | 'await-bids' | 'await-reveal' | 'resolution' | 'finished'
        winner: null,               // 'p1' | 'p2' | 'tie' at end
      };
    }

    // 7) Rendering
   function render() {
  if (!state) return;

  // --- Status message ---
  let statusMsg = '';
  if (!state.p2.name) {
    statusMsg = 'Game created. Waiting for opponent to join.';
  } else if (state.phase === 'await-bids') {
    statusMsg = selectedBid ? `You selected card ${selectedBid}. Commit your bid!`
                            : 'Place your bid!';
  } else if (state.phase === 'await-reveal') {
    statusMsg = 'Both bids are in. Reveal!';
  } else if (state.phase === 'resolution') {
    statusMsg = 'Round resolved. Click Next Turn.';
  } else if (state.phase === 'await-flip') {
    statusMsg = 'Flip the next table card.';
  } else {
    statusMsg = `Phase: ${state.phase}`;
  }
  $('statusText').textContent = statusMsg;

  // --- Player labels ---
  $('youPill').textContent = `You: ${youName || '—'}`;
  $('oppPill').textContent = `Opponent: ${state[role==='p1'?'p2':'p1'].name || '—'}`;

  // --- Table card ---
  $('tableCard').textContent = state.currentTableCard ?? '—';

  // --- Scores ---
  const your = state[role];
  const opp  = state[role==='p1'?'p2':'p1'];
  $('yourScore').textContent = (your.scoreCards || []).reduce((a,b)=>a+b,0);
  $('oppScore').textContent  = (opp.scoreCards || []).reduce((a,b)=>a+b,0);

  // --- War note ---
  $('warNote').textContent = state.warPile.length
    ? `War in progress: ${state.warPile.length} card(s)`
    : 'No war in progress.';

  // --- Hand grid ---
  const hg = $('handGrid');
  hg.innerHTML = '';
  (your.hand || []).forEach(v => {
    const btn = document.createElement('div');
    btn.className = 'bid' + (selectedBid===v ? ' selected' : '');
    btn.textContent = v;
    btn.onclick = () => {
      if (state.phase !== 'await-bids') return;
      selectedBid = v;
      render(); // refresh selection highlight
    };
    hg.appendChild(btn);
  });

  // --- War stack ---
  const ws = $('warStack');
  ws.innerHTML = '';
  state.warPile.forEach(v => {
    const c = document.createElement('div');
    c.className = 'cardface';
    c.textContent = v;
    ws.appendChild(c);
  });

  // --- Buttons ---
  $('commitBidBtn').disabled = !(state.phase === 'await-bids' && selectedBid !== null);
  $('revealBtn').disabled    = !(state.phase === 'await-reveal');
  $('nextTurnBtn').disabled  = !(state.phase === 'resolution');
}


    // 8) Sync listener
    stateRef().on('value', (snap) => {
      state = snap.val();
      if (!state) return;
      setHidden($('gameCard'), false);
      render();
      // if game finished, show summary
      if (state.phase === 'finished') {
        const youScore = state[role].scoreCards.reduce((a,b)=>a+b,0);
        const oppScore = state[role==='p1'?'p2':'p1'].scoreCards.reduce((a,b)=>a+b,0);
        const outcome = youScore===oppScore ? 'Tie game.' : (youScore>oppScore ? 'You win!' : 'You lose.');
        log(`Game finished. ${outcome} (You ${youScore} – Opp ${oppScore})`);
      }
    });

    // 9) Phases and actions
   async function createGame(id, yourNameInput) {
  gameId = id;
  youId = 'u_' + Math.random().toString(36).slice(2);
  role = 'p1';
  youName = yourNameInput || 'Player 1';

  const ref = gameRef();
  const exists = (await ref.get()).val();
  if (exists) {
    alert('Game ID already exists. Choose another.');
    return;
  }

  // Build initial state
  const init = initialState();
  init.p1.name = youName;

  // Write initial state to Firebase
  await ref.set({ state: init, players: { p1: youId } });

  // ✅ Flip the first table card immediately so game starts
  if (init.tableDeck.length > 0) {
    const firstCard = init.tableDeck[0];
    await stateRef().update({
      currentTableCard: firstCard,
      tableIndex: 1,
      phase: 'await-bids'   // advance to bidding
    });
    log(`Game created. First table card is ${firstCard}. Place your bid!`);
  }

  // Show UI
  setHidden($('connectCard'), true);
  setHidden($('linkCard'), false);
  $('shareLink').value = `${location.origin}${location.pathname}?game=${encodeURIComponent(gameId)}`;
  $('statusText').textContent = 'Game created. Waiting for opponent to join.';
  setHidden($('statusCard'), false);
  setHidden($('gameCard'), false);
  render();
}


    async function joinGame(id, yourNameInput) {
  gameId = id;
  youId = 'u_' + Math.random().toString(36).slice(2);
  role = 'p2';
  youName = yourNameInput || 'Player 2';

  const ref = gameRef();
  const current = (await ref.get()).val();
  if (!current) {
    alert('Game not found. Ask your friend to create it first.');
    return;
  }

  // Lock in p2 if slot free
  await ref.child('players/p2').transaction(val => val || youId);

  // ✅ Use youName here
  const p2Update = {
    name: youName,
    hand: current.state?.p2?.hand || range11(),
    bid: null,
    scoreCards: current.state?.p2?.scoreCards || []
  };
  await stateRef().child('p2').set(p2Update);

  setHidden($('connectCard'), true);
  setHidden($('linkCard'), true);
  setHidden($('statusCard'), false);
  setHidden($('gameCard'), false);
  $('statusText').textContent = 'Joined game.';
  render();
}


   async function flipTableCard() {
  if (!state) return;
  if (state.phase !== 'await-flip') return;

  if (state.tableIndex >= state.tableDeck.length) {
    await finishGame();
    return;
  }

  const next = state.tableDeck[state.tableIndex];
  await stateRef().update({
    currentTableCard: next,
    tableIndex: state.tableIndex + 1,
    phase: 'await-bids'   // ✅ always advance to bidding
  });

  log(`Table shows ${next}. Place your bid.`);
}


    // Commit bid with guard
    async function commitBid() {
      if (!state) {
        alert("Game state not loaded yet. Please wait until the game is ready.");
        return;
      }

      if (state.phase !== 'await-bids') return;
      if (selectedBid === null) return;

      const hand = state[role].hand.slice();
      const idx = hand.indexOf(selectedBid);
      if (idx === -1) {
        alert('That card is no longer in your hand.');
        return;
      }

      // Write bid and remove from hand
      const updates = {};
      updates[role + '/bid'] = selectedBid;
      hand.splice(idx, 1);
      updates[role + '/hand'] = hand;

      await stateRef().update(updates);

      // If both bids present, move to await-reveal
      const fresh = (await stateRef().get()).val();
      if (fresh && fresh.p1.bid !== null && fresh.p2.bid !== null && fresh.phase === 'await-bids') {
        await stateRef().update({ phase: 'await-reveal' });
      }

      render();
    }

    // Reveal bids with guard
    async function revealBidsAndResolve() {
      if (!state) {
        alert("Game state not loaded yet.");
        return;
      }
      if (state.phase !== 'await-reveal') return;

      const p1b = state.p1.bid, p2b = state.p2.bid;
      const tableCard = state.currentTableCard;

      log(`Reveal: P1 bid ${p1b}, P2 bid ${p2b}, table ${tableCard}`);

      if (p1b === p2b) {
        // War: add current table card to war pile, clear bids, next flip
        const newWar = state.warPile.slice();
        newWar.push(tableCard);

        await stateRef().update({
          warPile: newWar,
          currentTableCard: null,
          p1: { ...state.p1, bid: null },
          p2: { ...state.p2, bid: null },
          phase: 'await-flip'
        });
        log(`War continues. Pile size: ${newWar.length}`);
        return;
      }

      // Winner takes current table + war pile
      const winner = (p1b > p2b) ? 'p1' : 'p2';
      const wonCards = [tableCard, ...state.warPile];
      const winnerCards = state[winner].scoreCards.slice();
      wonCards.forEach(c => winnerCards.push(c));

      await stateRef().update({
        [winner]: { ...state[winner], scoreCards: winnerCards },
        warPile: [],
        phase: 'resolution'
      });

      log(`${winner.toUpperCase()} wins ${wonCards.join(', ')}.`);
    }

   async function nextTurn() {
  if (!state) {
    alert("Game state not loaded yet.");
    return;
  }
  if (!state.phase) {
    alert("Game phase not set yet.");
    return;
  }
  if (state.phase !== 'resolution') {
    log("Next turn not available. Current phase: " + state.phase);
    return;
  }

  const updates = {
    currentTableCard: null,
    p1: { ...state.p1, bid: null },
    p2: { ...state.p2, bid: null },
    phase: 'await-flip'
  };
  await stateRef().update(updates);

  // Auto-flip if cards remain
  await flipTableCard();
  selectedBid = null;
  render();
}


    async function finishGame() {
      // No more table cards, sum scores
      const p1Score = state.p1.scoreCards.reduce((a,b)=>a+b,0);
      const p2Score = state.p2.scoreCards.reduce((a,b)=>a+b,0);
      const winner = (p1Score === p2Score) ? 'tie' : (p1Score > p2Score ? 'p1' : 'p2');
      await stateRef().update({ phase: 'finished', winner });
      log(`Final: P1 ${p1Score}, P2 ${p2Score}. Winner: ${winner.toUpperCase()}`);
    }

    async function resetGame() {
      // Only allow reset by P1 for simplicity
      if (role !== 'p1') { alert('Only Player 1 can reset the game.'); return; }
      const init = initialState();
      init.p1.name = state.p1.name || 'Player 1';
      init.p2.name = state.p2.name || 'Player 2';
      await stateRef().set(init);
      log('Game reset.');
    }

    // 10) UI wiring
    $('createBtn').onclick = async () => {
      const id = ($('gameIdInput').value || '').trim();
      if (!id) return alert('Enter a game ID.');
      const yourNameInput = prompt('Enter your name (optional):') || 'Player 1';
      await createGame(id, yourNameInput);
      $('shareLink').value = `${location.origin}${location.pathname}?game=${encodeURIComponent(id)}`;
    };

    $('joinBtn').onclick = async () => {
      const id = ($('gameIdInput').value || '').trim();
      if (!id) return alert('Enter a game ID.');
      const yourNameInput = prompt('Enter your name (optional):') || 'Player 2';
      await joinGame(id, yourNameInput);
    };

    $('copyLink').onclick = async () => {
      await navigator.clipboard.writeText($('shareLink').value);
      alert('Link copied.');
    };

    $('commitBidBtn').onclick = commitBid;
    $('revealBtn').onclick = revealBidsAndResolve;
    $('nextTurnBtn').onclick = nextTurn;
    $('resetBtn').onclick = resetGame;

    // 11) Autoload by URL ?game=ID
    window.addEventListener('load', async () => {
      const params = new URLSearchParams(location.search);
      const gid = params.get('game');
      if (gid) {
        $('gameIdInput').value = gid;
        const choice = confirm('Join existing game? OK to join as Player 2, Cancel to create.');
        const name = prompt('Enter your name (optional):') || (choice ? 'Player 2' : 'Player 1');
        if (choice) {
          await joinGame(gid, name);
        } else {
          await createGame(gid, name);
        }
      }
      // If creator, auto-flip first card to start
      stateRef().on('value', async (s) => {
        const st = s.val();
        if (!st) return;
        if (st.phase === 'await-flip' && st.currentTableCard === null) {
          // Only p1 triggers flips to avoid races
          if (role === 'p1') {
            await flipTableCard();
          }
        }
      });
    });
  </script>
</body>
</html>
